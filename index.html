<html>

<head>
    <title>Proposta de Regras para Bolsas de Monitoria do CCA/UFSCar</title>
    <style>
        .framed {
            background-color: rgb(220, 220, 220);
            border-style: groove;
            padding: 7px;
            margin: 10px 5px;
        }
        .simulations {
            background-color: rgb(220, 220, 220);
            border-style: groove;
            padding: 7px;
            margin: 10px 5px;
        }
        #textRules {
            border-style: groove;
            padding: 7px;
            margin: 10px 5px;
        }
        #simulations {
            border-style: groove;
            padding: 20px;
            margin: 10px 5px;
            text-align: center;
        }
        #instructions {
            text-align: left;
        }
        button {
            background-color: khaki;
            padding: 10px;
            margin: 10px 5px;
            border-width: 2px;
            border-radius: 7px;            
            font-weight: bold;
        }
        li {
            padding-bottom: 5px;
            padding-top: 5px;
        }
        input {
            width: 70px;
            text-align: center;
        }
        h3 {
            text-align: center;
        }        
        table {
            text-align: center;
            margin: auto;
        }
    </style>
</head>

<body id="body">
    <div id="textRules">
        <h3>Proposta de Regras para Bolsas de Monitoria do CCA/UFSCar</h3>
        <p><b>Atenção: </b> este conjunto de regras é uma proposta que encontra-se em análise e, portanto, não possui ainda qualquer valor legal.</p>
        <ol>            
            <li>A Comissão de Bolsas de Monitoria do CCA/UFSCar (CBM-CCA) deverá definir a distribuição de bolsas de monitoria entre os departamentos do CCA/UFSCar respeitando os critérios estebelecidos neste documento.</li>
            <li>O prazo máximo para a definição da distribuição de bolsas pela CBM-CCA será de 10 dias após a disponibilização de vagas pela ProGrad/UFSCar.
            <li>Não há limite de vagas não remuneradas para bolsistas voluntários, sendo os critérios e limites dessa modalidade de vaga definidos por cada departamento. Portanto, este conjunto de regras aplica-se somente às vagas remuneradas.
            <li>Não há limitação de solicitações de bolsas por docente ou por turma.</li>
            <li>
                A distribuição das bolsas por departamento seguirá o processo na ordem a seguir:
                <ol>
                    <li>Chamaremos de \(B_S\) o número total de bolsas solicitadas e de \(B_D\) o número total de bolsas disponíveis para o CCA.</li>
                    
                    <li>Caso \(B_{S} \leq B_{D}\), todas as solicitações serão atendidas e encerra-se o processo.</li>
                    
                    <li>Caso \(B_{S} > B_{D}\), verifica-se qual é o número \(N_{S_{max}}\) que corresponde ao maior número de bolsas solicitadas para uma mesma turma.</li>
                    
                    <li>Caso \(N_{S_{max}} > 1\), cada turma que contenha a solicitação de \(N_{S_{max}}\) terá a sua solicitação reduzida em 1 (uma) bolsa. Essas reduções produzirão um número total de bolsas solicitadas reduzidas, que chamaremos de \(B_{SR}\). Caso \(B_{SR} \leq B_{D}\), as solicitações reduzidas serão atendidas e encerra-se o processo. Caso contrário, verifica-se qual é o \(N_{SR_{max}}\) das solicitações reduzidas e aplica-se o procedimento do início deste item. Esse procedimento é repetido até que \(B_{SR} \leq B_{D}\).</li>
                    
                    <li>Caso todas as solicitações reduzidas contemplem pelo menos uma bolsa por turma e \(B_{SR} \leq B_{D}\), as solicitações reduzidas serão atendidas e encerra-se o processo.</li>            

                    <li>Chamaremos de \(N_{D_S}\) o número de departamentos que estejam solicitando 1 (uma) ou mais bolsas.</li>
                    
                    <li>Caso \(B_{SR} > B_{D}\) e \(N_{D_S} > B_{D}\), então as bolsas serão distribuídas seguindo os critérios de desempate especificados no item <a href="#tiebreaker">Critérios de desempate</a>.</li>                    
                    
                    <li>Caso \(B_{SR} > B_{D}\) e \(N_{D_S} \leq B_{D}\) segue-se o processo a seguir:
                        <ol>
                            <li>Calcula-se o peso do \(i\)-ésimo departamento (\(P_i\)) utilizando procedimento idêntico (substituindo-se os Centros pelos Departamentos) ao definido no documento <a href="https://drive.google.com/drive/folders/1KD-pdkrKwo-ZX3BRwBnqRgv7GwE4GL8G?usp=share_link"><em>Relatório da Comissão do Programa de Monitoria da UFSCar</em> utilizado pela <em>Resolução COG No 316, de 10 de fevereiro de 2020</em></a> ou em documento mais atualizado. Aquele procedimento define que:
                                \begin{equation}
                                    P_{i} = \frac{Q_{I_i} + Q_{R_i} + Q_{T_i} + Q_{P_i} + N_{T_i}}{P_T}
                                \end{equation}
                            em que:
                            <ul>
                                <li>\(P_{T} = \sum_{i}(Q_{I_i} + Q_{R_i} + Q_{T_i} + Q_{P_i} + N_{T_i})\) é o fator de normalização.</li>
                                <li>\(Q_{I_i}\) é a quantidade de inscrições em atividades no \(i\)-ésimo departamento nos últimos 5 anos.</li>
                                <li>\(Q_{R_i}\) é a quantidade de reprovações no \(i\)-ésimo departamento nos últimos 5 anos.</li>
                                <li>\(Q_{T_i}\) é a quantidade de créditos teóricos no \(i\)-ésimo departamento nos últimos 5 anos.</li>
                                <li>\(Q_{P_i}\) é a quantidade de créditos práticos no \(i\)-ésimo departamento nos últimos 5 anos.</li>
                                <li>\(N_{T_i}\) é a quantidade de turmas ofertadas pelo \(i\)-ésimo departamento nos últimos 5 anos.</li>
                            </ul>
                            No caso da resolução COG 316-10/02/20, como últimos 5 anos foram considerados os anos de 2014 a 2018. Além disso, naquela resolução, acordou-se que "para avaliar os números acima, não seriam consideradas as ACIEPEs, atividades de estágio, projeto e monografia, atividades na modalidade EAD e atividades normalmente contempladas pelo Programa de Tutoria". Todas essas decisões também serão adotadas para o cálculo de cada \(P_{i}\) do CCA.
                            </li>
        
                            <li>Define-se \(B_{G_i}\) como sendo a quantidade mínima de bolsas garantidas para o \(i\)-ésimo departamento, calculado por:
                                \begin{equation}
                                    B_{G_i} = P_{i}B_{D}
                                \end{equation}
                            </li>
        
                            <li>O \(i\)-ésimo departamento que apresentar, simultaneamente, \(B_{G_i} < 1\) e \(B_{SR_i} \geq 1\) terá a sua quantidade mínima de bolsas garantidas corrigida para \(B_{G_i} = 1\).</li>
        
                            <li>Define-se \(B_{D_i}\) como sendo a quantidade de bolsas disponibilizadas ao \(i\)-ésimo departamento, em que, consequentemente \(B_{D}=\sum_{i}B_{D_i}\).</li>
        
                            <li>A distribuição das bolsas entre os departamentos deverá minimizar a diferença quadrática \(\sigma^2\) entre o número de bolsas disponibilizadas para o \(i\)-ésimo departamento e \(B_{G_i}\):
                                \begin{equation}
                                    \sigma^{2}=\underset{B_{D_i}}{\text{min}} \sum_{i}{\left(B_{D_i} - B_{G_i}\right)^{2}}           
                                \end{equation}                                                                
                            </li>
        
                            <li>Caso haja mais que um conjunto \(B_{D_i}\) com mesmo valor de \(\sigma^2\) mínimo, deverão ser aplicados os critérios de desempate especificados no item <a href="#tiebreaker">Critérios de desempate</a>.</li>
                        </ol>
                    </li>                       
                    
                    <li><b id="tiebreaker">Critérios de desempate</b>: privilegiar-se-á a distribuição de bolsas que favoreça o departamento com maior valor de \(Q_{I_i}\), seguido do maior \(Q_{R_i}\), maior \(Q_{P_i}\), maior \(Q_{T_i}\) e maior \(N_{T_i}\), nessa ordem, até que sobre uma única distribuição de bolsas. Essa ordem somente deverá ser quebrada se for para satisfazer a condição de que todo departamento tenha pelo menos a solicitação de 1 (uma) bolsa atendida a cada 2 (dois) semestres, conforme o disposto na resolução COG 316-10/02/20.</li>

                    <li>Casos omissos serão deliberados pela CBM-CCA.</li>
                    
                    </ul>                
                </ol>
            </li>

            <li>A distribuição das bolsas \(B_{D_i}\) entre as solicitações do \(i\)-ésimo departamento deverão ser feitas a cargo do representante da CBM-CCA do correspondente departamento utilizando critérios que satisfaçam o atendimento às disciplinas represadas e as que tenham pré-requisitos que foram ministrados durante os ENPEs, sendo esses critérios aprovados no respectivo departamento.</li>

        </ol>	  	
    </div>

    <div id="simulations">
        <h3>Simulação da distribuição de bolsas</h2>
        <ul id="instructions">
            <li>Informe o número de bolsas disponíveis \(B_D\) no campo de texto corresponde.</li>

            <li>Informe o peso \(P_{i}\) de cada departamento nos campos correspondentes. Eles não necessitam estar normalizados, pois a simulação realiza a normalização. <b>Atenção:</b> os valores de \(P_{i}\) automaticamente carregados na página são apenas um exemplo. Os valores corretos deverão ser levantados pelo CCA conforme explicado na Proposta de Regras.</li>

            <li>Informe o número \(B_{SR_i}\) de bolsas solicitadas por cada departamento nos campos correspondentes.</li>

            <li>Clique no botão <b>Calcular distribuição de bolsas</b>. As bolsas a serem distribuídas serão informadas ao lado do rótulo \(B_{D_i}\). Caso haja mais que um conjunto \(B_{D_i}\) que resulte no mesmo \(\sigma^2\) mínimo, os conjuntos serão apresentados um abaixo do outro em ordem arbitrária. Nesse caso deverão ser aplicados os <a href="#tiebreaker">Critérios de desempate</a>.</li>
        </ul>
        <div>
            <p><label for="BD">Bolsas disponíveis (\(B_{D}\)): </label><input type="text" id="BD" value="11"></p>
        </div>
        <div>
            <table>
                <tr>
                    <th></th>
                    <td>DBPVA</td>
                    <td>DCNME</td>
                    <td>DDR</td>
                    <td>DRNPA</td>
                    <td>DTAiSeR</td>
                </tr>
                <tr>    
                    <th>\(P_i\)</th>
                    <td><input type="text" id="Pi_DBPVA" name="Pi" value="3"></td>
                    <td><input type="text" id="Pi_DCNME" name="Pi" value="4"></td>
                    <td><input type="text" id="Pi_DDR" name="Pi" value="2"></td>
                    <td><input type="text" id="Pi_DRNPA" name="Pi" value="1"></td>
                    <td><input type="text" id="Pi_DTAiSeR" name="Pi" value="2"></td>
                </tr>
                <tr>    
                    <th>\(B_{SR_i}\)</th>
                    <td><input type="text" id="BSRi_DBPVA" name="BSRi" value="6"></td>
                    <td><input type="text" id="BSRi_DCNME" name="BSRi" value="1"></td>
                    <td><input type="text" id="BSRi_DDR" name="BSRi" value="1"></td>
                    <td><input type="text" id="BSRi_DRNPA" name="BSRi" value="1"></td>
                    <td><input type="text" id="BSRi_DTAiSeR" name="BSRi" value="3"></td>
                </tr>
                <tr>    
                    <th>\(B_{G_i}\)</th>
                    <td><input type="text" id="BGi_DBPVA" name="BGi" value="" readonly="readonly"></td>
                    <td><input type="text" id="BGi_DCNME" name="BGi" value="" readonly="readonly"></td>
                    <td><input type="text" id="BGi_DDR" name="BGi" value="" readonly="readonly"></td>
                    <td><input type="text" id="BGi_DRNPA" name="BGi" value="" readonly="readonly"></td>
                    <td><input type="text" id="BGi_DTAiSeR" name="BGi" value="" readonly="readonly"></td>
                </tr>
                <tr>    
                    <th>\(B_{D_i}\)</th>
                    <td><p id="BDi_DBPVA" name="BDi"></p></td>
                    <td><p id="BDi_DCNME" name="BDi"></p></td>
                    <td><p id="BDi_DDR" name="BDi"></p></td>
                    <td><p id="BDi_DRNPA" name="BDi"></p></td>
                    <td><p id="BDi_DTAiSeR" name="BDi"></p></td>
                </tr>
                </table>
        </div>    
        <button id="calcButton" onclick="calcDist()">Calcular distribuição de bolsas</button>    
    </div>
    
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>        

    <script>

        window.MathJax = {tex: {tags: 'ams'}};  //For latex equations automatic numbering
        
        const tots = {'Pi': 0, 'BSRi': 0, 'BDi': 0};        
        
        const Deps = {};        
        for (let dep of document.getElementsByName('Pi')) Deps[dep.getAttribute('id').split('_')[1]] = {};
        let totDeps = Object.keys(Deps).length;
                
        let depGrants = [];

        function calcDist () {

            depGrants = [];
            tots['Pi'] = 0;
            tots['BSRi'] = 0;
            tots['BDi'] = Number(document.getElementById('BD').value);
            Dsolics = 0;                        
            for (let name of ['Pi', 'BSRi']) {
                for (let x of document.getElementsByName(name)) {                    
                    let v = Number(x.value.replace(',', '.'));
                    Deps[x.getAttribute('id').split('_')[1]][name] = v;
                    tots[name] += v;            
                    if (name == 'BSRi' && v > 0) Dsolics++;
                }
            }    

            if (Dsolics > tots['BDi']) {
                let i = 0;
                for (let dep in Deps) document.getElementById('BDi_' + dep).innerHTML = '';
                alert('Atenção: o número de departamentos solicitantes de bolsas é maior que o número de bolsas disponíveis. Vide as regras para esse caso.')
            }
            else {
                document.getElementById("calcButton").innerHTML = "Aguarde. Calculando...";
                for (let dep in Deps) {
                    let BGi = tots['BDi']*Deps[dep]['Pi']/tots['Pi'];
                    if ((Deps[dep]['BSRi'] >= 1) && (BGi < 1)) Deps[dep]['BGi'] = 1;                    
                    else Deps[dep]['BGi'] = BGi;
                    document.getElementById('BGi_' + dep).value = Deps[dep]['BGi'].toFixed(3)
                }

                if (tots['BDi'] >= tots['BSRi']) {
                    let grant = [];
                    for (let dep in Deps) grant.push(Number(document.getElementById('BSRi_' + dep).value));
                    depGrants.push({'dev': 0, 'grant': grant});
                }
                else genDepGrants([], 0, 0);
                                
                //Filter valid grant distributions:                
                filteredGrants = []
                for (let grant of depGrants) {
                    let i = 0;
                    let c = 1;
                    for (let dep in Deps) {                        
                        if (grant['grant'][i] > Deps[dep]['BSRi']) c *= 0;
                        i++;                        
                    }
                    if (c == 1) filteredGrants.push(grant);
                }
                console.log(filteredGrants);
                depGrants = filteredGrants;

                let depGrantsSorted = depGrants.sort((a, b) => {
                    if (a['dev'] > b['dev']) return 1;
                    else if (a['dev'] < b['dev']) return -1;
                    else return 0;
                });
                            
                let minDepGrants = [];
                const epsilon = 1e-6;
                for (let grant of depGrantsSorted) {
                    if (Math.abs(grant['dev'] - depGrantsSorted[0]['dev']) < epsilon) minDepGrants.push(grant);
                    else break;
                }
                
                let i = 0;
                for (let dep in Deps) { 
                    let grantString = '';                
                    for (let grant of minDepGrants) grantString += grant['grant'][i] + ' <br>';
                    document.getElementById('BDi_' + dep).innerHTML = grantString;
                    i++;
                }       
                
                document.getElementById("calcButton").innerHTML = "Calcular distribuição de bolsas";
            }
        }      
                
        function genDepGrants (perm, sa, sb) {
            if ((sa + sb) < (tots['BDi'] + totDeps - 1)) {                
                if (sa < tots['BDi']) {                   
                    let permN = perm.slice(0, perm.length); //just a perm copy 
                    permN.push('a');
                    genDepGrants(permN, sa + 1, sb);
                }
                if (sb < totDeps - 1) {                    
                    let permN = perm.slice(0, perm.length); //just a perm copy
                    permN.push('b');                
                    genDepGrants(permN, sa, sb + 1);
                }
            }
            else {
                let grant = permsToGrants(perm);
                let dev = stdDev(grant);
                depGrants.push({'dev': dev, 'grant': grant});
            }
        }            
        
        function permsToGrants (perm) {
            let grant = [];
            let s = 0;
            for (let i = 0; i < perm.length; i++) {                
                if (perm[i] == 'a') s += 1;
                else {
                    grant.push(s);
                    s = 0;                    
                }                
            }
            grant.push(s);
            return(grant);
        }

        function stdDev (grant) {            
            let dev = 0
            let i = 0;
            let item;
            let penal = 1000;            
            for (let dep in Deps) {                 
                dev += (grant[i] - Deps[dep]['BGi'])**2;
                i++;
            }
            return dev;
        }        
                
    </script>

</body>

</html>
